rank = [0.07606898, 0.10301852, 0.06453177, 0.08126815, 0.06919647,...
       0.08869201, 0.08274937, 0.07574666, 0.07863266, 0.10381656,...
       0.0424862 , 0.10295816, 0.06593039, 0.0488183 , 0.04177995,...
       0.10945732, 0.07389005, 0.09488635, 0.07346289, 0.05056905,...
       0.07102917, 0.10940495, 0.07080158, 0.05613769, 0.06496244,...
       0.08786786, 0.07158963, 0.08651018, 0.07151955, 0.07351212,...
       0.09036354, 0.06577114, 0.07008276, 0.04738682, 0.06327742,...
       0.06994921, 0.1088038 , 0.10981426, 0.05890556, 0.08176303,...
       0.08429938, 0.07331553, 0.11375488, 0.07025049, 0.06195115,...
       0.04840794, 0.06310858, 0.06467334, 0.09538691, 0.06227498,...
       0.0678209 , 0.04971801, 0.11346628, 0.0432049 , 0.08641088,...
       0.05903439, 0.04597617, 0.04459925, 0.07712931, 0.0570903 ,...
       0.07425839, 0.04221897, 0.05033411, 0.05237877, 0.07562394,...
       0.07348261, 0.07649927, 0.06189301, 0.07054775, 0.07171207,...
       0.0936668 , 0.06592623, 0.08064185, 0.08375781, 0.05265651,...
       0.07733879, 0.05294795, 0.04781083, 0.06065353, 0.06268798,...
       0.05349134, 0.08624022, 0.04282088, 0.05440609, 0.05358929,...
       0.06097881, 0.07581248, 0.04952994, 0.0764838 , 0.09608901,...
       0.07192795, 0.07662007, 0.10574554, 0.07817413, 0.04023406,...
       0.08260162, 0.04659328, 0.07667715, 0.04122272, 0.05108524,...
       0.04689384, 0.05644693, 0.04950186, 0.05667691, 0.0354713 ,...
       0.05146258, 0.04365987, 0.05417798, 0.08381206, 0.07001569,...
       0.08081939, 0.09094981, 0.08727062, 0.07823089, 0.10170484,...
       0.10364127, 0.03887078, 0.06271308, 0.07196821, 0.04723634,...
       0.096405  , 0.0696832 , 0.06938609, 0.06472269, 0.06275002,...
       0.0376723 , 0.07013989, 0.05786711, 0.07240257];
   
   
rank = [0.08190985, 0.10760179, 0.06465953, 0.07742975, 0.07062977,...
       0.08434274, 0.09005026, 0.07178437, 0.0804555 , 0.09908132,...
       0.04247729, 0.1001916 , 0.05837188, 0.04603334, 0.03845601,...
       0.11305908, 0.0783472 , 0.08983405, 0.07512787, 0.05377594,...
       0.06644699, 0.1187542 , 0.06679573, 0.05080402, 0.0611296 ,...
       0.096411  , 0.07239282, 0.09589028, 0.08136894, 0.07439183,...
       0.09265555, 0.07336606, 0.07344085, 0.04648698, 0.06069901,...
       0.06637453, 0.10967827, 0.11123297, 0.05771509, 0.0749588 ,...
       0.0903124 , 0.07067645, 0.11007139, 0.07848293, 0.0711738 ,...
       0.04972741, 0.05822072, 0.0661242 , 0.09016368, 0.06232138,...
       0.0650745 , 0.04699375, 0.11239059, 0.04605191, 0.08997303,...
       0.05776449, 0.03859032, 0.04050428, 0.07567486, 0.05317425,...
       0.07042287, 0.03694186, 0.0501137 , 0.06054362, 0.06842002,...
       0.07584756, 0.07843046, 0.06048946, 0.06667001, 0.06967912,...
       0.08739186, 0.07437961, 0.08420005, 0.0919856 , 0.04982465,...
       0.07706596, 0.05868248, 0.04883134, 0.05603279, 0.06084984,...
       0.0501562 , 0.07692366, 0.03639134, 0.0519699 , 0.04714853,...
       0.06541812, 0.08526633, 0.04444479, 0.08379098, 0.10275338,...
       0.07266562, 0.08275466, 0.10267737, 0.07796845, 0.04228552,...
       0.09321086, 0.04748088, 0.06974419, 0.03588202, 0.0521465 ,...
       0.04063765, 0.05898343, 0.04461926, 0.0589706 , 0.03261996,...
       0.04798191, 0.04376648, 0.05944643, 0.08336794, 0.07218263,...
       0.07611883, 0.09128928, 0.09097642, 0.08791723, 0.10227983,...
       0.10223406, 0.03578337, 0.06767639, 0.06833052, 0.03794579,...
       0.10141423, 0.06969754, 0.07677365, 0.0590256 , 0.06417348,...
       0.03453927, 0.06856904, 0.05599649, 0.07072147];
   
rank = [0.08194226, 0.10593377, 0.06677089, 0.07789483, 0.07074291,...
       0.08468532, 0.09022021, 0.07358893, 0.08180888, 0.09701713,...
       0.04469819, 0.09610274, 0.06014035, 0.04973089, 0.04185076,...
       0.10677611, 0.07777654, 0.0892814 , 0.0753478 , 0.05555693,...
       0.066785  , 0.11383548, 0.0680174 , 0.0506806 , 0.06241156,...
       0.09338856, 0.07188047, 0.09148706, 0.07993326, 0.07454049,...
       0.09186888, 0.07183484, 0.07305255, 0.04881433, 0.06040749,...
       0.06566752, 0.10671722, 0.10790673, 0.06121486, 0.07469837,...
       0.08917293, 0.0716858 , 0.10575544, 0.07860961, 0.07068264,...
       0.04960489, 0.06125369, 0.06745645, 0.08683632, 0.0617646 ,...
       0.06764732, 0.04816099, 0.10702079, 0.04671401, 0.08752148,...
       0.05939805, 0.04200261, 0.04312181, 0.07433572, 0.05503979,...
       0.07012935, 0.03888926, 0.05128254, 0.06194692, 0.06963067,...
       0.07536859, 0.08035829, 0.05871634, 0.06754687, 0.06896231,...
       0.08684035, 0.07243213, 0.08364146, 0.09039089, 0.05114001,...
       0.07660947, 0.05874719, 0.05112218, 0.05795284, 0.06356225,...
       0.05086321, 0.07593591, 0.0415522 , 0.05643816, 0.04856162,...
       0.06717715, 0.08239593, 0.04534616, 0.08086612, 0.09721971,...
       0.07446634, 0.08289646, 0.09968959, 0.07697309, 0.04345726,...
       0.08710322, 0.04921561, 0.0668873 , 0.03879195, 0.05666817,...
       0.04344611, 0.05903197, 0.04598813, 0.06098002, 0.03516153,...
       0.04853066, 0.0478743 , 0.05868804, 0.08254118, 0.06973541,...
       0.07688395, 0.08814006, 0.08554154, 0.08632206, 0.10067267,...
       0.10199001, 0.03774207, 0.06714679, 0.06756105, 0.04105501,...
       0.10027396, 0.06994062, 0.07565537, 0.05923675, 0.06558389,...
       0.03822972, 0.06737958, 0.05449664, 0.06960138];
   
rank = [rank',linspace(1,129,129)'];   
   
[~,idx] = sort(rank(:,1),'descend'); % sort just the first column
sortedmat = rank(idx,:);

cm_control = [];
cm_l20 = [];
cm_l30 = [];
cm_l50 = [];

comb_idx_train = [1,2, 4,5, 7,8, 10,11; 1,2, 4,6, 7,9, 10,12; 1,2, 5,6, 8,9, 11,12;...
    1,3, 4,5, 7,8, 10,11;1,3, 4,6, 7,9, 10,12;1,3, 5,6, 8,9, 11,12;...
    2,3, 4,5, 7,8, 10,11; 2,3, 4,6, 7,9, 10,12; 2,3, 5,6, 8,9, 11,12];

comb_idx_test = [3, 6, 9, 12; 3, 5, 8, 11; 3, 4, 7, 10;...
    2, 6, 9, 12; 2, 5, 8, 11;2, 4, 7, 10;...
    1, 6, 9, 12; 1, 5, 8, 11; 1, 4, 7, 10];

totalfeatcv_test = [];

for i=1:1 %[1:14]
    totalcv_test = [];

    for k = 1:9
        BiomarkerDataBase_train = features(comb_idx_train(k,:),:);
        BiomarkerDataBase_test = features(comb_idx_test(k,:),:);
        BiomarkerDataBase_trat = features_trat;

        Labels_BM_train = [0,0,1,1,2,2,3,3];
        Labels_BM_test = [0,1,2,3];
        Labels_BM_trat = [3,3,3,3,3,3,3,3,3,3];

        %feature_select = sortedmat([1:7],2); %! best
        %feature_select = sortedmat([1,2,5,6],2);
        %feature_select = [22,38,53,43];
        %feature_select = sortedmat([1,],2); %! best 1,3,5,7
        feature_select = [22];
        
        %feature_select = sortedmat([1:i],2);
        %feature_select = sortedmat([i],2);
        
        % Clasifications
        % Train
        X = BiomarkerDataBase_train(:,feature_select);
        Y = Labels_BM_train;
        Mdl = fitcknn(X,Y,'NumNeighbors',3); %'Standardize',1 ,'Distance','minkowski'
        y_pred_train = predict(Mdl,BiomarkerDataBase_train(:,feature_select));

        % Test
        y_pred_test = predict(Mdl,BiomarkerDataBase_test(:,feature_select));
        
        % Treatments
        y_pred_trat = predict(Mdl,BiomarkerDataBase_trat(:,feature_select));
        
        totalcv_test = [totalcv_test, y_pred_test];
    end

    totalfeatcv_test(:,:,i) = totalcv_test;

end


length_features = size(totalfeatcv_test(1,:,:),3);

% Control
cm_control = [sum(reshape(totalfeatcv_test(1,:,:), [9,length_features])' == 0, 2), ...
    sum(reshape(totalfeatcv_test(1,:,:), [9,length_features])' == 1, 2),... 
    sum(reshape(totalfeatcv_test(1,:,:), [9,length_features])' == 2, 2),... 
    sum(reshape(totalfeatcv_test(1,:,:), [9,length_features])' == 3, 2)]; % confusion con 3

% L20
cm_l20 = [sum(reshape(totalfeatcv_test(2,:,:), [9,length_features])' == 0, 2), ...
    sum(reshape(totalfeatcv_test(2,:,:), [9,length_features])' == 1, 2),... 
    sum(reshape(totalfeatcv_test(2,:,:), [9,length_features])' == 2, 2),... 
    sum(reshape(totalfeatcv_test(2,:,:), [9,length_features])' == 3, 2),]; % confusion con 3

% L30 
cm_l30 = [sum(reshape(totalfeatcv_test(3,:,:), [9,length_features])' == 0, 2), ...
    sum(reshape(totalfeatcv_test(3,:,:), [9,length_features])' == 1, 2),... 
    sum(reshape(totalfeatcv_test(3,:,:), [9,length_features])' == 2, 2),... 
    sum(reshape(totalfeatcv_test(3,:,:), [9,length_features])' == 3, 2),]; % confusion con 3

% L50 
cm_l50 = [sum(reshape(totalfeatcv_test(4,:,:), [9,length_features])' == 0, 2), ...
    sum(reshape(totalfeatcv_test(4,:,:), [9,length_features])' == 1, 2),... 
    sum(reshape(totalfeatcv_test(4,:,:), [9,length_features])' == 2, 2),... 
    sum(reshape(totalfeatcv_test(4,:,:), [9,length_features])' == 3, 2),]; 

%cm_control
%cm_l20
%cm_l30
%cm_l50
precision = [100.*cm_control(:,1)./9, 100.*cm_l20(:,2)./9, ...
    100.*cm_l30(:,3)./9, 100.*cm_l50(:,4)./9];
disp([precision, mean(precision,2)])

